name: Deploy to EC2

on:
    push:
        branches: [master] # æ¯æ¬¡ push åˆ° main åˆ†æ”¯æ™‚è§¸ç™¼éƒ¨ç½²æµç¨‹

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest # ä½¿ç”¨ GitHub æä¾›çš„ Ubuntu runner

        steps:
            - name: Checkout code
              uses: actions/checkout@v3
              # ä¸‹è¼‰ä½  GitHub repo çš„åŸå§‹ç¢¼

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: 20
              # å®‰è£ Node.js 20 ç’°å¢ƒ

            - name: Install dependencies
              run: npm install
              # å®‰è£ npm å¥—ä»¶ï¼ˆæ ¹æ“š package.jsonï¼‰

            - name: Set .env & Build Vue app
              run: |
                  echo "VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}" > .env
                  echo "VITE_APP_VERSION=${{ secrets.VITE_APP_VERSION }}" >> .env
                  echo "VITE_ENV_MODE=${{ secrets.VITE_ENV_MODE }}" >> .env

                  npm run build
              # é€™è£¡çš„ secrets æ˜¯ GitHub Secrets è£¡è¨­å®šçš„è®Šæ•¸
              # è¨­å®šç’°å¢ƒè®Šæ•¸ä¸¦åŸ·è¡Œ npm run build

            - name: Compress dist content (no dist folder)
              run: |
                  cd dist
                  tar -czf ../vue-app.tar.gz .
              # é€²å…¥ dist/ è³‡æ–™å¤¾å¾Œæ‰“åŒ…å®ƒçš„å…§å®¹ï¼Œè€Œä¸æ˜¯åŒ…å« dist æœ¬èº«
              # çµæœï¼švue-app.tar.gz è£¡é¢æ˜¯ index.html, assets/ ç­‰

            - name: Upload tar.gz to EC2:/tmp
              uses: appleboy/scp-action@v0.1.4
              with:
                  host: ${{ secrets.EC2_HOST }} # EC2 å…¬ç¶² IP æˆ– DNS
                  username: ${{ secrets.EC2_USER }} # ä¸€èˆ¬æ˜¯ ubuntu
                  key: ${{ secrets.EC2_KEY }} # SSH ç§é‘°
                  source: 'vue-app.tar.gz'
                  target: '/tmp'
              # ä½¿ç”¨ scp æŠŠ vue-app.tar.gz ä¸Šå‚³åˆ° EC2 çš„ /tmp ç›®éŒ„

            - name: Deploy and extract to /var/www/html
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_KEY }}
                  script: |
                      sudo rm -rf /var/www/html/*                 # æ¸…ç©ºèˆŠçš„ç¶²ç«™å…§å®¹
                      sudo mkdir -p /var/www/html                 # ç¢ºä¿è³‡æ–™å¤¾å­˜åœ¨
                      sudo tar -xzf /tmp/vue-app.tar.gz -C /var/www/html  # è§£å£“ç¸®é€² html ç›®éŒ„
                      sudo rm /tmp/vue-app.tar.gz                 # åˆªé™¤ä¸­ç¹¼æª”æ¡ˆ
                      # å¯é¸ï¼šé‡å•Ÿ nginxï¼ˆè¦–ä¼ºæœå™¨è¨­å®šï¼‰
                      # sudo systemctl restart nginx
              # ä½¿ç”¨ SSH é ç«¯ç™»å…¥ï¼Œè§£å£“ä¸¦éƒ¨ç½²æª”æ¡ˆ

            - name: Notify Discord (success or failure)
              if: always()
              run: |
                  STATUS="${{ job.status }}"
                  COLOR="âœ…"
                  MESSAGE="goticket å‰ç«¯å°ˆæ¡ˆéƒ¨ç½²ç’°å¢ƒæˆåŠŸï¼ ğŸš€\n"

                  if [ "$STATUS" != "success" ]; then
                    COLOR="âŒ"
                    MESSAGE="goticket å‰ç«¯å°ˆæ¡ˆéƒ¨ç½²ç’°å¢ƒå¤±æ•—ï¼ â—ï¸\n"
                  fi

                  curl -X POST ${{ secrets.DISCORD_WEBHOOK_URL }} \
                    -H "Content-Type: application/json" \
                    -d "{
                      \"content\": \"$COLOR $MESSAGE\nğŸ“¦ å°ˆæ¡ˆï¼š${{ github.repository }}\nğŸ‘¤ æ¨é€è€…ï¼š${{ github.event.pusher.name }}\nğŸŒ¿ åˆ†æ”¯ï¼š${{ github.ref_name }}\nğŸ• æ™‚é–“ï¼š$(TZ=Asia/Taipei date '+%Y-%m-%d %H:%M')\"
                    }"
              # ç™¼é€ Discord é€šçŸ¥ï¼Œå‘ŠçŸ¥éƒ¨ç½²ç‹€æ…‹
